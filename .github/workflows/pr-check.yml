name: Pull Request Check

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]

jobs:
  # ============================================
  # PR Validation
  # ============================================
  validate-pr:
    name: Validate PR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR title format
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for merge conflicts
        run: |
          git fetch origin ${{ github.base_ref }}
          git merge-tree $(git merge-base HEAD origin/${{ github.base_ref }}) HEAD origin/${{ github.base_ref }} > /dev/null || echo "Potential merge conflicts detected"

  # ============================================
  # Backend Checks
  # ============================================
  backend-check:
    name: Backend Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint --if-present

      - name: Check for vulnerabilities
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Syntax check
        run: node -c server.js

  # ============================================
  # Frontend Checks
  # ============================================
  frontend-check:
    name: Frontend Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.0'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Verify formatting
        run: dart format --output=none --set-exit-if-changed .
        continue-on-error: true

      - name: Analyze code
        run: flutter analyze --no-fatal-infos

  # ============================================
  # Comment on PR
  # ============================================
  comment:
    name: PR Comment
    runs-on: ubuntu-latest
    needs: [backend-check, frontend-check]
    if: always()

    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const backendResult = '${{ needs.backend-check.result }}';
            const frontendResult = '${{ needs.frontend-check.result }}';
            
            let body = '## PR Check Results\n\n';
            body += `| Check | Status |\n`;
            body += `| ----- | ------ |\n`;
            body += `| Backend | ${backendResult === 'success' ? '✅ Passed' : '❌ Failed'} |\n`;
            body += `| Frontend | ${frontendResult === 'success' ? '✅ Passed' : '❌ Failed'} |\n`;
            
            if (backendResult !== 'success' || frontendResult !== 'success') {
              body += '\n⚠️ Please fix the failing checks before merging.';
            } else {
              body += '\n✅ All checks passed! Ready for review.';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
